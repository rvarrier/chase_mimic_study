<!DOCTYPE html>
<html>
<head>
<title>Animations study</title>

<script src="Intro_text.js"></script>
<script src="jspsych/jspsych.js"></script>
    
   
<link rel="stylesheet" href="jspsych/jspsych.css" />
 <script src="jspsych/plugin-preload.js"></script>
 <script src="jspsych/plugin-video-keyboard-response.js"></script>
 <script src="jspsych/plugin-html-slider-response.js"></script>
 <script src="jspsych/plugin-survey-text.js"></script>
 <script src="jspsych/plugin-instructions.js"></script>
 <script src="jspsych/plugin-survey-multi-choice.js"></script>
 <script src="jspsych/plugin-survey-multi-select.js"></script>
 <script src="jspsych/plugin-html-keyboard-response.js"></script>
 <script src="jspsych/plugin-fullscreen.js"></script>
 <script src="jspsych/plugin-survey-html-form.js"></script>


<!DOCTYPE html>
<script>

var jsPsych = initJsPsych({
    adapt_to_file_protocol: false,
    override_safe_mode: true,
    
    on_finish: function() { jsPsych.data.displayData(); 

      var date = new Date().toISOString().slice(0, 10)
      jsPsych.data.get().localSave('csv','data' + '.csv'); } //or what ever you want! 
//jsPsych.data.get().localSave('csv','data/eventsegbehav_participant' + jsPsych.timelineVariable(participant,"true") +'.csv'); }
});

// You will probably want this from Prolific 
var participant = jsPsych.data.getURLVariable('participant');
var participant = Number(participant)

// or you can get it manually 
var participant = 1
var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
var study_id = jsPsych.data.getURLVariable('STUDY_ID');
var session_id = jsPsych.data.getURLVariable('SESSION_ID');


// use this function randomize when you get to that
function random_item(items)
{return items[Math.floor(Math.random()*items.length)];   }
function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;}  

timeline_temp = []

var enter_fullscreen = {
  type: jsPsychFullscreen,
  fullscreen_mode: false
}

//consent form
var consent_form = {
    type: jsPsychSurveyHtmlForm,
    preamble: text_list[0].consent_form_naturalistic,
    // html: consent_nat[0].consent_form_naturalistic + "<p><input type=checkbox id=consent_checkbox required/>I agree to take part in this study. </p>"
    html: "<p><input type=checkbox id=consent_checkbox required/> <strong> I agree to take part in this study. </strong> </p>"
};
timeline_temp.push(enter_fullscreen,consent_form)

// devices_off
var devices_off = {
    type: jsPsychSurveyHtmlForm,
    preamble: text_list[1].devices_off_1,
    html: "  ",
    response_ends_trial:true, 
    button_label: "Understood. Continue."
  };
timeline_temp.push(devices_off)

var devices_off = {
    type: jsPsychSurveyHtmlForm,
    preamble: text_list[1].devices_off_2,
    html: "  ",
    response_ends_trial:true, 
    button_label: "All done. Continue."
  };
timeline_temp.push(devices_off)

//instructions - REDUCE TEXT!
instr_animation = 'animations/chase__pred_subt0_Black_Posx_350_1.webm'
var instr_files = {
  type: jsPsychVideoKeyboardResponse,
  stimulus: [instr_animation], // this will be a variable once you have all of them 
  response_ends_trial:true, 
  response_allowed_while_playing:true,
  controls: false,
  trial_duration: null,//6000, //in ms
  loop:true,
  width: 600,
  border:5,
  choices: "1",
  prompt:text_list[2].instructions_txt_1 + '<p><input type=checkbox id=instr_checkbox required/> <strong>Understood.</strong> </p>'
  //prompt: text_list[2].instructions_txt_1 + "<p><input type=checkbox id=instr_resp required/> Continue to demo </p>"
};
timeline_temp.push(instr_files)

var instr_q1 = {
    type: jsPsychHtmlSliderResponse,
    stimulus: text_list[2].instructions_txt_2,
    require_movement:true, //slider will not advance until they move it
    labels: ['Random', 'Chase'], // if you want to randomly change which is on which side let me know and I can show you how to implement that (you need to use JS and then generate 2 variables that are called in here)
    rt: 5000,
    response_ends_trial: true
  }
timeline_temp.push(instr_q1)

var instr_q2 = {
    type: jsPsychSurveyMultiChoice,
    questions: [
      {
    //prompt: "Which circle did you think was the chaser? Make a guess if you didn't see a chase at all.",
    prompt: text_list[2].instructions_txt_3,
    options: [`<img src="circle_img/black_circle.png" width="25" height="25"`, `<img src="circle_img/grey_circle.png" width="25" height="25"`],
    horizontal:true,
    rt: 5000,
    response_ends_trial: false
      },]
    } 
timeline_temp.push(instr_q2)

//Demo begins
function generateRandomInteger(max) {
    return Math.floor(Math.random() * max);
}
demo_animations_files = ['animations/chase__pred_subt0_Black_Posx_350_1.webm',
'animations/chase__pred_subt0_Black_Posx_350_2.webm']

var intro_page = {
    type: jsPsychSurveyHtmlForm,
    preamble: "Demo begins. Please keep your eyes on the screen, and try to respond quickly, but as precisely as possible.",
    html: "  ",
    response_ends_trial:true, 
    button_label: "Continue."
  };
timeline_temp.push(intro_page)

//elements for each trial
var animation_playing = {
    type: jsPsychVideoKeyboardResponse,
    stimulus: [], // webm filename
    response_ends_trial:false, 
    width: 600,
    border:5,
    response_allowed_while_playing:false,
    trial_duration: 6000 //in ms
  };

var slider_chase = {
    type: jsPsychHtmlSliderResponse,
    stimulus: '<div style="width:800px;"><p><strong>Question 1: Was there a chase, or were the circles moving randomly?<br>Indicate your choice on the continuous bar below.</p></div>',
    require_movement:true, //slider will not advance until they move it
    labels: ['Random', 'Chase'], // if you want to randomly change which is on which side let me know and I can show you how to implement that (you need to use JS and then generate 2 variables that are called in here)
    rt: 5000, // NOTE: you will likely want to set ceilings for the timing on this 
    response_ends_trial: true
  } // best to not randomixe chase/random, but can randomie initial cursor position if needed  (although we'd have to include it as a regressor later)

var circle_choice = {
    type: jsPsychSurveyMultiChoice,
    questions: [{
    prompt: "<strong>Question 2: Which circle could have been the chaser?<br>Make a guess if you didn't see a chase at all.</strong>",
    options: [`<img src="circle_img/black_circle.png" width="25" height="25"`, `<img src="circle_img/grey_circle.png" width="25" height="25"`],
    horizontal:true,
      }] // optional: swap black/grey order
  }

repeat_demo = 'True';
while (repeat_demo == 'True') {
  for (i = 0; i <2; i++) {
    demo_ind = generateRandomInteger(demo_animations_files.length) // 0 or 1 for now
    animation_playing.stimulus = [demo_animations_files[demo_ind]]
    timeline_temp.push( animation_playing, slider_chase, circle_choice)
  }
  repeat_demo = 'False';
  //if (i==1): // optioanl: ask subjects if theyr want to do the demo again
}

// Main expt section
var intro_page = {
    type: jsPsychSurveyHtmlForm,
    preamble: "<p>Main experiment begins.<br>Please keep your eyes on the screen until the next break</p>",
    html: "  ",
    response_ends_trial:true, 
    button_label: "Continue."
  };
  //intro_page.preamble = "Main experiment begins.."
timeline_temp.push(intro_page)

for (i = 0; i <9; i++) {
  animation_playing.stimulus = ['animations/chase__pred_subt0_Black_Posx_350_1.webm'],
  timeline_temp.push( animation_playing, slider_chase, circle_choice)

  if (i%7 ==0) {
  var break_screen = {
    type: jsPsychSurveyHtmlForm,
    preamble: "Break. Press continue when ready to proceed.",
    response_ends_trial:true, 
    html: ' ',
    button_label: "Continue"
  };
timeline_temp.push(break_screen);
}
  // can implement a break every couple of trials once you add a loop

}
//timeline_temp.push(animation_playing)

var post_hoc_qns = {
  type: jsPsychSurveyHtmlForm,
  preamble: '<strong>Did you use any strategies while performing this task? </strong>',
  html: '<input name="strategies" type="text" />'
};
timeline_temp.push(post_hoc_qns);

var post_hoc_qns = {
  type: jsPsychSurveyHtmlForm,
  preamble: '<strong>Any other feedback? </strong>',
  html: '<input name="feedback" type="text" />'
};
timeline_temp.push(post_hoc_qns);

//Demographic Questions
var demographic_mcq = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "<strong> How would you describe your gender? </strong>", 
      name: 'gender', 
      options: ['Male', 'Female', 'Non-binary', 'Other', 'Prefer not to say'], 
      required: false,
      horizontal: true
    }, 
    {
      prompt: "<strong> Are you of hispanic or latinx origin? </strong>", 
      name: 'hispanic', 
      options: ['Yes', 'No', 'Neither', 'Prefer not to say'], 
      required: false,
      horizontal: true
    }
  ],
};

var race = { 
    type: jsPsychSurveyMultiSelect,
    questions: [ {
      prompt: "<strong> How would you describe your race? </strong>", 
      name: 'race', 
      options: ['American Indian/Alaska Native', 'Asian', 'Native Hawaiian or Other Pacific Islander', 'Black or African American', 'White', 'More than one race', 'Do not wish to report'], 
      required: false,
      horizontal: true
    }]}

timeline_temp.push(demographic_mcq)
jsPsych.run(timeline_temp)


var post_hoc_qns = {
  type: jsPsychSurveyHtmlForm,
  preamble: '<strong>Age</strong>',
  html: '<input name="age" type="numeric" />'
};
timeline_temp.push(post_hoc_qns);

var post_hoc_qns = {
  type: jsPsychSurveyHtmlForm,
  preamble: '<strong>Location: </strong>',
  html: '<input name="location" type="text" />'
};
timeline_temp.push(post_hoc_qns);

// var goodbye = {
//     type: "image-keyboard-response_Original", //jsPsychHtmlKeyboardResponse,
//     stimulus: "Thank you for your participation! <strong> Press any key to submit your data (you are not done until you do and will not get paid) </strong>. This will then take you back to the Prolific page" ,
//     on_finish: function(){
//       saveData("_data",jsPsych.data.get().csv());
//   save_data_csv();
//     }
//     };
//     timeline_temp.push(goodbye);



//jsPsych.data.get().localSave('csv','data/eventsegbehav_participant' + jsPsych.timelineVariable(participant,"true") +'.csv'); }
// });

// jsPsych.init({
// show_progress_bar: true, //added a progress bar! 
// timeline: timeline_temp,
// override_safe_mode: true,
// //timeline_variables: timeline_vars, //comment this in when you start looping through trials
// on_finish: function(){

//   //jsPsych.data.displayData();
//   saveData("_data",jsPsych.data.get().csv());
//   save_data_csv();
//   //window.location.replace('https://app.prolific.co/submissions/complete?cc=27267BF2');}

//   window.location.replace('https://rcweb.dartmouth.edu/homes/f004p59/madlibs_full_task_3random/closing.html')}
// });

//THIS LAST PART IS FOR SAVING THE DATA! IT NEEDS TO BE FIXED FOR YOUR OWN EXPERIMENT AND PATHWAYS

// function saveData(name, data){
//   var xhr = new XMLHttpRequest();
//   xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
//   xhr.setRequestHeader('Content-Type', 'application/json');
//   xhr.send(JSON.stringify({filedata: data}));
// }

// // call the saveData function after the experiment is over
// var date = new Date().toISOString().slice(0, 10)
// const d = new Date();
// let time = d.getTime();
// jsPsych.data.addProperties({
//         time_done: time})
// var save_url = "https://rcweb.dartmouth.edu/homes/f004p59/madlibs_full_task_3random/write_data.php";
// function save_data_csv() {
//         jQuery.ajax({
//             type: 'post',
//             cache: false,
//             url: save_url,
//             data: {
//                 data_dir: "data",
//                 file_name: 'madlibs_3random_participant' + participant + '_' +date+ '_' + time+'.csv', // the file type should be added
//                 exp_data: jsPsych.data.get().csv()
//             }
//         });
//     }
// function save_temp_data_csv() {
//     //const d = new Date();
//     let time = d.getTime();
//         jQuery.ajax({
//             type: 'post',
//             cache: false,
//             url: save_url,
//             data: {
//                 data_dir: "data",
//                 file_name: 'madlibs_3random_participant' + participant + '_' +'temp'+ '_' + time +'.csv', // the file type should be added
//                 exp_data: jsPsych.data.get().csv()
//             }
//         });
//     }

</script>
</body>
</html>
